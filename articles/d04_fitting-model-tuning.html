<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Performing grid search in tidyflow • tidyflow</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/paper/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Performing grid search in tidyflow">
<meta property="og:description" content="tidyflow">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-93322-5"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-93322-5');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">tidyflow</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href=".././index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-gears"></span>
     
    Reference
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-graduation-cap"></span>
     
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/a01_intro_tidyflow.html">An introduction to tidyflow</a>
    </li>
    <li>
      <a href="../articles/b02_model-with-recipe.html">Using recipes in tidyflow</a>
    </li>
    <li>
      <a href="../articles/c03_fitting-model-resampling.html">Using resampling in tidyflow</a>
    </li>
    <li>
      <a href="../articles/d04_fitting-model-tuning.html">Grid search in tidyflow</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-file-powerpoint"></span>
     
    Presentations
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/berlinrug_202009.pdf">Berlin RUG September 2020</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/cimentadaj/tidyflow/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="d04_fitting-model-tuning_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Performing grid search in tidyflow</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/cimentadaj/tidyflow/blob/master/vignettes/d04_fitting-model-tuning.Rmd"><code>vignettes/d04_fitting-model-tuning.Rmd</code></a></small>
      <div class="hidden name"><code>d04_fitting-model-tuning.Rmd</code></div>

    </div>

    
    
<p>This vignette aims to exemplify how you can use resampling and tuning within a <code>tidyflow</code>.</p>
<p>A tidyflow is a bundle of steps that allow you to bundle together your data, splitting, resampling, preprocessing, modeling, and grid search. For executing a grid search, the <code>tidymodels</code> ecosystem contains the <code>tune</code> package. <code>tune</code> allows you to run many sub-models, each one with a different combination of tuning parameters, with the aim of choosing the best final model.</p>
<p><a href="./c03_fitting-model-resampling.html">In another vignette</a>, we discussed the concept of resampling and how it can be used to evaluate the stability of a model. For performing a grid search, resampling is a natural step because we need to try a combination of tuning values for each parameter in a model. In other words, we will run many models with different values for the models parameters and we need a way to get random samples from the data. Resampling is thus combined with a general strategy of trying out different sub-models.</p>
<p>Let’s define a random forest model but we want to try different values in the <code>trees</code> argument. We can signal that with the <code><a href="https://tune.tidymodels.org/reference/tune.html">tune()</a></code> function. This just means that the <code>trees</code> will be <code>tune</code>d.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidymodels.tidymodels.org">tidymodels</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/cimentadaj/tidyflow">tidyflow</a></span><span class="op">)</span>

<span class="va">rf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://parsnip.tidymodels.org/reference/rand_forest.html">rand_forest</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"regression"</span>, trees <span class="op">=</span> <span class="fu"><a href="https://tune.tidymodels.org/reference/tune.html">tune</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_engine.html">set_engine</a></span><span class="op">(</span><span class="st">"randomForest"</span><span class="op">)</span>
<span class="va">rf</span>
<span class="co">#&gt; Random Forest Model Specification (regression)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Main Arguments:</span>
<span class="co">#&gt;   trees = tune()</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Computational engine: randomForest</span></code></pre></div>
<p>At this point, we haven’t really ‘defined’ which values will be used for <code>trees</code>. It could be 3 values (such as 100, 200 and 300) or it could be 500. The package <code>tune</code> hosts a family of functions named <code>grid_*</code> which provide different approaches to sampling random number from different tuning arguments. For example, let’s use <code>grid_regular</code> to obtain an evenly spaced set of values for <code>trees</code>. This is how you would do it in <code>tidymodels</code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">even_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dials.tidymodels.org/reference/grid_regular.html">grid_regular</a></span><span class="op">(</span><span class="fu"><a href="https://dials.tidymodels.org/reference/trees.html">trees</a></span><span class="op">(</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="va">even_values</span>
<span class="co">#&gt; # A tibble: 10 x 1</span>
<span class="co">#&gt;    trees</span>
<span class="co">#&gt;    &lt;int&gt;</span>
<span class="co">#&gt;  1     1</span>
<span class="co">#&gt;  2   223</span>
<span class="co">#&gt;  3   445</span>
<span class="co">#&gt;  4   667</span>
<span class="co">#&gt;  5   889</span>
<span class="co">#&gt;  6  1111</span>
<span class="co">#&gt;  7  1333</span>
<span class="co">#&gt;  8  1555</span>
<span class="co">#&gt;  9  1777</span>
<span class="co">#&gt; 10  2000</span></code></pre></div>
<p><code>grid_regular</code> already knows which ‘sensible’ range of values to try. <code>tidyflow</code> provides the function <code>plug_grid</code> that allows you to specify the type of grid search you want to perform. Let’s divide the data into training/testing, specify a cross-validation and plug in the random forest and a <code>grid_regular</code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tflow</span> <span class="op">&lt;-</span>
  <span class="va">mtcars</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/tidyflow.html">tidyflow</a></span><span class="op">(</span>seed <span class="op">=</span> <span class="fl">57136</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plug_formula.html">plug_formula</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plug_split.html">plug_split</a></span><span class="op">(</span><span class="va">initial_split</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plug_resample.html">plug_resample</a></span><span class="op">(</span><span class="va">vfold_cv</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plug_model.html">plug_model</a></span><span class="op">(</span><span class="va">rf</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plug_grid.html">plug_grid</a></span><span class="op">(</span><span class="va">grid_regular</span><span class="op">)</span>

<span class="va">tflow</span>
<span class="co">#&gt; ══ Tidyflow ════════════════════════════════════════════════════════════════════</span>
<span class="co">#&gt; Data: 32 rows x 11 columns</span>
<span class="co">#&gt; Split: initial_split w/ default args</span>
<span class="co">#&gt; Formula: mpg ~ .</span>
<span class="co">#&gt; Resample: vfold_cv w/ default args</span>
<span class="co">#&gt; Grid: grid_regular w/ default args</span>
<span class="co">#&gt; Model:</span>
<span class="co">#&gt; Random Forest Model Specification (regression)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Main Arguments:</span>
<span class="co">#&gt;   trees = tune()</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Computational engine: randomForest</span></code></pre></div>
<p>This grid search specification knows that <code>trees</code> is the only argument to be searched for. We can execute the grid search with just a single call to <code>fit</code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res</span> <span class="op">&lt;-</span> <span class="va">tflow</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; randomForest 4.6-14</span>
<span class="co">#&gt; Type rfNews() to see new features/changes/bug fixes.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'randomForest'</span>
<span class="co">#&gt; The following object is masked from 'package:ggplot2':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     margin</span>
<span class="co">#&gt; The following object is masked from 'package:dplyr':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     combine</span>
<span class="co">#&gt; ! Fold08: internal: A correlation computation is required, but `estimate` is const...</span>
<span class="va">res</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/tidyflow-extractors.html">pull_tflow_fit_tuning</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Warning: This tuning result has notes. Example notes on model fitting include:</span>
<span class="co">#&gt; internal: A correlation computation is required, but `estimate` is constant and has 0 standard deviation, resulting in a divide by 0 error. `NA` will be returned.</span>
<span class="co">#&gt; # Tuning results</span>
<span class="co">#&gt; # 10-fold cross-validation </span>
<span class="co">#&gt; # A tibble: 10 x 4</span>
<span class="co">#&gt;    splits         id     .metrics         .notes          </span>
<span class="co">#&gt;    &lt;list&gt;         &lt;chr&gt;  &lt;list&gt;           &lt;list&gt;          </span>
<span class="co">#&gt;  1 &lt;split [21/3]&gt; Fold01 &lt;tibble [6 × 5]&gt; &lt;tibble [0 × 1]&gt;</span>
<span class="co">#&gt;  2 &lt;split [21/3]&gt; Fold02 &lt;tibble [6 × 5]&gt; &lt;tibble [0 × 1]&gt;</span>
<span class="co">#&gt;  3 &lt;split [21/3]&gt; Fold03 &lt;tibble [6 × 5]&gt; &lt;tibble [0 × 1]&gt;</span>
<span class="co">#&gt;  4 &lt;split [21/3]&gt; Fold04 &lt;tibble [6 × 5]&gt; &lt;tibble [0 × 1]&gt;</span>
<span class="co">#&gt;  5 &lt;split [22/2]&gt; Fold05 &lt;tibble [6 × 5]&gt; &lt;tibble [0 × 1]&gt;</span>
<span class="co">#&gt;  6 &lt;split [22/2]&gt; Fold06 &lt;tibble [6 × 5]&gt; &lt;tibble [0 × 1]&gt;</span>
<span class="co">#&gt;  7 &lt;split [22/2]&gt; Fold07 &lt;tibble [6 × 5]&gt; &lt;tibble [0 × 1]&gt;</span>
<span class="co">#&gt;  8 &lt;split [22/2]&gt; Fold08 &lt;tibble [6 × 5]&gt; &lt;tibble [1 × 1]&gt;</span>
<span class="co">#&gt;  9 &lt;split [22/2]&gt; Fold09 &lt;tibble [6 × 5]&gt; &lt;tibble [0 × 1]&gt;</span>
<span class="co">#&gt; 10 &lt;split [22/2]&gt; Fold10 &lt;tibble [6 × 5]&gt; &lt;tibble [0 × 1]&gt;</span></code></pre></div>
<p>The result is a resampling object with the evaluation metrics measuring the performance of different values for <code>trees</code> across the 10 resamples. You can look at more clearly the performance of the model using different values for trees using <code><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot()</a></code> on the resampling result:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/tidyflow-extractors.html">pull_tflow_fit_tuning</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="figures/tuning-grid_search_tuning1-1.png" alt=""><p class="caption">plot of chunk grid_search_tuning1</p>
</div>
<p>It seems the grid randomly chose three values for <code>trees</code> (X axis has three points on <code>1</code>, <code>1000</code> and <code>2000</code>) and as expected, as the number of trees increases, the <code>rsq</code> is higher and the <code>rmse</code> is lower.</p>
<p>This grid search strategy is really just a quick way to get some models running. However, it allows for much more flexibility. For example, we can play around with the number of values to sample from by just providing an extra argument to <code>plug_grid</code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tflow</span> <span class="op">&lt;-</span>
  <span class="va">mtcars</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/tidyflow.html">tidyflow</a></span><span class="op">(</span>seed <span class="op">=</span> <span class="fl">57136</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plug_formula.html">plug_formula</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plug_split.html">plug_split</a></span><span class="op">(</span><span class="va">initial_split</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plug_resample.html">plug_resample</a></span><span class="op">(</span><span class="va">vfold_cv</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plug_model.html">plug_model</a></span><span class="op">(</span><span class="va">rf</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plug_grid.html">plug_grid</a></span><span class="op">(</span><span class="va">grid_regular</span>, levels <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>

<span class="va">tflow</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/tidyflow-extractors.html">pull_tflow_fit_tuning</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="figures/tuning-grid_search_tuning2-1.png" alt=""><p class="caption">plot of chunk grid_search_tuning2</p>
</div>
<p>The random grid contains now 10 values. What if we wanted to limit the range of the values used in the resampling?</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tflow</span> <span class="op">&lt;-</span>
  <span class="va">mtcars</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/tidyflow.html">tidyflow</a></span><span class="op">(</span>seed <span class="op">=</span> <span class="fl">57136</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plug_formula.html">plug_formula</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plug_split.html">plug_split</a></span><span class="op">(</span><span class="va">initial_split</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plug_resample.html">plug_resample</a></span><span class="op">(</span><span class="va">vfold_cv</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plug_model.html">plug_model</a></span><span class="op">(</span><span class="va">rf</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plug_grid.html">plug_grid</a></span><span class="op">(</span><span class="va">grid_regular</span>, trees <span class="op">=</span> <span class="fu"><a href="https://dials.tidymodels.org/reference/trees.html">trees</a></span><span class="op">(</span>range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>

<span class="va">tflow</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/tidyflow-extractors.html">pull_tflow_fit_tuning</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="figures/tuning-grid_search_tuning3-1.png" alt=""><p class="caption">plot of chunk grid_search_tuning3</p>
</div>
<p>This approach works just as well with <strong>any</strong> of the <code>grid_*</code> functions. However, what if we simply wanted to provide the values to try? That is, we don’t want any type of ‘random sampling’. <code>plug_grid</code> allows the user to specify the function <code>expand.grid</code> and just provide the values to be used in the grid search. For example:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tflow</span> <span class="op">&lt;-</span>
  <span class="va">mtcars</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/tidyflow.html">tidyflow</a></span><span class="op">(</span>seed <span class="op">=</span> <span class="fl">57136</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plug_formula.html">plug_formula</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plug_split.html">plug_split</a></span><span class="op">(</span><span class="va">initial_split</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plug_resample.html">plug_resample</a></span><span class="op">(</span><span class="va">vfold_cv</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plug_model.html">plug_model</a></span><span class="op">(</span><span class="va">rf</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plug_grid.html">plug_grid</a></span><span class="op">(</span><span class="va">expand.grid</span>, trees <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span>

<span class="va">tflow</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/tidyflow-extractors.html">pull_tflow_fit_tuning</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Warning: Duplicate rows in grid of tuning combinations found and removed.</span>
<span class="co">#&gt; ! Fold08: internal: A correlation computation is required, but `estimate` is const...</span></code></pre></div>
<div class="figure">
<img src="figures/tuning-grid_search_tuning4-1.png" alt=""><p class="caption">plot of chunk grid_search_tuning4</p>
</div>
<p>This flexibility works just as well with any number of tuning parameters for the model. You can specify as many as parameters as you want, and even manually customize some of the parameters while the <code>grid_*</code> functions takes care of randomly sampling the others. For example, let’s say we wanted to run a random forest while tuning the parameters <code>trees</code>, <code>min_n</code> and <code>mtry</code>. Suppose that on top of that we wanted to manually limit the range of <code>trees</code> to be between 5 and 20, the <code>min_n</code> to be <code>20</code> (fixed) and allow the grid sampling to sample <code>mtry</code> randomly from ‘sensible’ values. We do that just as we’ve been manually updating the parameters values in <code>plug_grid</code>:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rf</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/rand_forest.html">rand_forest</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"regression"</span>,
              trees <span class="op">=</span> <span class="fu"><a href="https://tune.tidymodels.org/reference/tune.html">tune</a></span><span class="op">(</span><span class="op">)</span>,
              min_n <span class="op">=</span> <span class="fl">20</span>,
              mtry <span class="op">=</span> <span class="fu"><a href="https://tune.tidymodels.org/reference/tune.html">tune</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_engine.html">set_engine</a></span><span class="op">(</span><span class="st">"randomForest"</span><span class="op">)</span>

<span class="va">tflow</span> <span class="op">&lt;-</span>
  <span class="va">mtcars</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/tidyflow.html">tidyflow</a></span><span class="op">(</span>seed <span class="op">=</span> <span class="fl">57136</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plug_formula.html">plug_formula</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plug_split.html">plug_split</a></span><span class="op">(</span><span class="va">initial_split</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plug_resample.html">plug_resample</a></span><span class="op">(</span><span class="va">vfold_cv</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plug_model.html">plug_model</a></span><span class="op">(</span><span class="va">rf</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plug_grid.html">plug_grid</a></span><span class="op">(</span><span class="va">grid_regular</span>, trees <span class="op">=</span> <span class="fu"><a href="https://dials.tidymodels.org/reference/trees.html">trees</a></span><span class="op">(</span>range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>

<span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span><span class="va">tflow</span><span class="op">)</span>
<span class="va">res</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/tidyflow-extractors.html">pull_tflow_fit_tuning</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="figures/tuning-grid_search_tuning5-1.png" alt=""><p class="caption">plot of chunk grid_search_tuning5</p>
</div>
<p>If you want to extract the actual grid used behind the scenes, <code>pull_tflow_grid</code> returns exactly that, after the model has been fitted.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/tidyflow-extractors.html">pull_tflow_grid</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 4 x 2</span>
<span class="co">#&gt;    mtry trees</span>
<span class="co">#&gt;   &lt;int&gt; &lt;int&gt;</span>
<span class="co">#&gt; 1     1     5</span>
<span class="co">#&gt; 2    10     5</span>
<span class="co">#&gt; 3     1    20</span>
<span class="co">#&gt; 4    10    20</span></code></pre></div>
<p>Once you’ve tuned your model you want to choose the final model. <code>complete_tflow</code> takes care of finding by the best combination of values for you. When you provide the metric of interest, it searches for the combination of parameters with the lowest error for your metric:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">final_mod</span> <span class="op">&lt;-</span> <span class="va">res</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/complete_tflow.html">complete_tflow</a></span><span class="op">(</span>metric <span class="op">=</span> <span class="st">"rmse"</span><span class="op">)</span>

<span class="co"># Otherwise, you can provide the values manually yourself</span>
<span class="co"># best &lt;- data.frame(trees = 10, min_n = 20, mtry = 5)</span>
<span class="co"># final_mod &lt;- res %&gt;% complete_tflow(best_params = best)</span>

<span class="va">final_mod</span>
<span class="co">#&gt; ══ Tidyflow [trained] ══════════════════════════════════════════════════════════</span>
<span class="co">#&gt; Data: 32 rows x 11 columns</span>
<span class="co">#&gt; Split: initial_split w/ default args</span>
<span class="co">#&gt; Formula: mpg ~ .</span>
<span class="co">#&gt; Resample: vfold_cv w/ default args</span>
<span class="co">#&gt; Grid: grid_regular w/ trees = ~trees(range = c(5, 20)), levels = ~2</span>
<span class="co">#&gt; Model:</span>
<span class="co">#&gt; Random Forest Model Specification (regression)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Main Arguments:</span>
<span class="co">#&gt;   mtry = 10</span>
<span class="co">#&gt;   trees = 20</span>
<span class="co">#&gt;   min_n = 20</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Computational engine: randomForest </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ══ Results ═════════════════════════════════════════════════════════════════════</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Tuning results: </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; # A tibble: 5 x 4</span>
<span class="co">#&gt;   splits         id     .metrics         .notes          </span>
<span class="co">#&gt;   &lt;list&gt;         &lt;chr&gt;  &lt;list&gt;           &lt;list&gt;          </span>
<span class="co">#&gt; 1 &lt;split [21/3]&gt; Fold01 &lt;tibble [8 × 6]&gt; &lt;tibble [0 × 1]&gt;</span>
<span class="co">#&gt; 2 &lt;split [21/3]&gt; Fold02 &lt;tibble [8 × 6]&gt; &lt;tibble [0 × 1]&gt;</span>
<span class="co">#&gt; 3 &lt;split [21/3]&gt; Fold03 &lt;tibble [8 × 6]&gt; &lt;tibble [0 × 1]&gt;</span>
<span class="co">#&gt; 4 &lt;split [21/3]&gt; Fold04 &lt;tibble [8 × 6]&gt; &lt;tibble [0 × 1]&gt;</span>
<span class="co">#&gt; 5 &lt;split [22/2]&gt; Fold05 &lt;tibble [8 × 6]&gt; &lt;tibble [0 × 1]&gt;</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ... and 5 more lines.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Fitted model:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt;  randomForest(x = as.data.frame(x), y = y, ntree = ~20L, mtry = ~10L,      nodesize = ~20) </span>
<span class="co">#&gt;                Type of random forest: regression</span>
<span class="co">#&gt;                      Number of trees: 20</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ...</span>
<span class="co">#&gt; and 4 more lines.</span></code></pre></div>
<p><code>complete_tflow</code> takes care of fitting the model with the best parameters on the entire training data. Now you can predict on the training or testing data automatically with <code>predict_training</code> or <code>predict_testing</code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">final_mod</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/predict-tidyflow.html">predict_training</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">rsq</span><span class="op">(</span><span class="va">mpg</span>, <span class="va">.pred</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 1 x 3</span>
<span class="co">#&gt;   .metric .estimator .estimate</span>
<span class="co">#&gt;   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;</span>
<span class="co">#&gt; 1 rsq     standard       0.875</span></code></pre></div>
<p>The <code>tune</code> package and <code>tidymodels</code> are very powerful tools for doing machine learning. In this vignette, I tried to extend their work by providing a unified interface for working with <code>tune</code> that uses the grid search framework bundled together with all the other common machine learning steps.</p>
<p>Want to see tidyflow and tune in action? The <code>tidymodels</code> team has a vignette showcasing how to use <code>tune</code> and <code>tidymodels</code> <a href="https://www.tidymodels.org/start/case-study/">here</a>. I’ve adapted their code to fully run within a <code>tidyflow</code> workflow. Here’s the replication code:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidymodels.tidymodels.org">tidymodels</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/cimentadaj/tidyflow">tidyflow</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">readr</span><span class="op">)</span>       <span class="co"># for importing data</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">vip</span><span class="op">)</span>         <span class="co"># for variable importance plots</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">readr</span><span class="op">)</span>

<span class="va">hotels</span> <span class="op">&lt;-</span>
  <span class="fu">read_csv</span><span class="op">(</span><span class="st">"https://tidymodels.org/start/case-study/hotels.csv"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate_if</span><span class="op">(</span><span class="va">is.character</span>, <span class="va">as.factor</span><span class="op">)</span>

<span class="va">lr_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://parsnip.tidymodels.org/reference/logistic_reg.html">logistic_reg</a></span><span class="op">(</span>penalty <span class="op">=</span> <span class="fu"><a href="https://tune.tidymodels.org/reference/tune.html">tune</a></span><span class="op">(</span><span class="op">)</span>, mixture <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_engine.html">set_engine</a></span><span class="op">(</span><span class="st">"glmnet"</span><span class="op">)</span>

<span class="va">holidays</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"AllSouls"</span>, <span class="st">"AshWednesday"</span>, <span class="st">"ChristmasEve"</span>, <span class="st">"Easter"</span>,
              <span class="st">"ChristmasDay"</span>, <span class="st">"GoodFriday"</span>, <span class="st">"NewYearsDay"</span>, <span class="st">"PalmSunday"</span><span class="op">)</span>

<span class="va">lr_recipe</span> <span class="op">&lt;-</span>
  <span class="op">~</span> <span class="va">.x</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html">recipe</a></span><span class="op">(</span><span class="va">children</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_date.html">step_date</a></span><span class="op">(</span><span class="va">arrival_date</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_holiday.html">step_holiday</a></span><span class="op">(</span><span class="va">arrival_date</span>, holidays <span class="op">=</span> <span class="va">holidays</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_rm.html">step_rm</a></span><span class="op">(</span><span class="va">arrival_date</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_dummy.html">step_dummy</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html">all_nominal</a></span><span class="op">(</span><span class="op">)</span>, <span class="op">-</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html">all_outcomes</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_zv.html">step_zv</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html">all_predictors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_normalize.html">step_normalize</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html">all_predictors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">tflow</span> <span class="op">&lt;-</span>
  <span class="va">hotels</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/tidyflow.html">tidyflow</a></span><span class="op">(</span>seed <span class="op">=</span> <span class="fl">123</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plug_split.html">plug_split</a></span><span class="op">(</span><span class="va">initial_split</span>, strata <span class="op">=</span> <span class="st">"children"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plug_resample.html">plug_resample</a></span><span class="op">(</span><span class="va">validation_split</span>, strata <span class="op">=</span> <span class="st">"children"</span>, prop <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plug_recipe.html">plug_recipe</a></span><span class="op">(</span><span class="va">lr_recipe</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plug_grid.html">plug_grid</a></span><span class="op">(</span><span class="va">expand.grid</span>, penalty <span class="op">=</span> <span class="fl">10</span><span class="op">^</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">4</span>, <span class="op">-</span><span class="fl">1</span>, length.out <span class="op">=</span> <span class="fl">30</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plug_model.html">plug_model</a></span><span class="op">(</span><span class="va">lr_mod</span><span class="op">)</span>

<span class="va">cntrl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/control_tidyflow.html">control_tidyflow</a></span><span class="op">(</span>control_grid <span class="op">=</span> <span class="fu"><a href="https://tune.tidymodels.org/reference/control_grid.html">control_grid</a></span><span class="op">(</span>save_pred <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
<span class="va">p_res</span> <span class="op">&lt;-</span> <span class="va">tflow</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>control <span class="op">=</span> <span class="va">cntrl</span><span class="op">)</span>

<span class="va">p_res</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/tidyflow-extractors.html">pull_tflow_fit_tuning</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tune.tidymodels.org/reference/collect_predictions.html">collect_metrics</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">.metric</span> <span class="op">==</span> <span class="st">"roc_auc"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">penalty</span>, y <span class="op">=</span> <span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">ylab</span><span class="op">(</span><span class="st">"Area under the ROC Curve"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_x_log10</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org//reference/label_number.html">label_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">top_models</span> <span class="op">&lt;-</span>
  <span class="va">p_res</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/tidyflow-extractors.html">pull_tflow_fit_tuning</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tune.tidymodels.org/reference/show_best.html">show_best</a></span><span class="op">(</span><span class="st">"roc_auc"</span>, n <span class="op">=</span> <span class="fl">15</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">arrange</span><span class="op">(</span><span class="va">penalty</span><span class="op">)</span>

<span class="va">lr_best</span> <span class="op">&lt;-</span> <span class="va">top_models</span> <span class="op">%&gt;%</span> <span class="fu">slice</span><span class="op">(</span><span class="fl">12</span><span class="op">)</span>

<span class="va">lr_auc</span> <span class="op">&lt;-</span>
  <span class="va">p_res</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/tidyflow-extractors.html">pull_tflow_fit_tuning</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tune.tidymodels.org/reference/collect_predictions.html">collect_predictions</a></span><span class="op">(</span>parameters <span class="op">=</span> <span class="va">lr_best</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">roc_curve</span><span class="op">(</span><span class="va">children</span>, <span class="va">.pred_children</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>model <span class="op">=</span> <span class="st">"Logistic Regression"</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">lr_auc</span><span class="op">)</span>

<span class="co"># Let's run in parallel</span>
<span class="va">cores</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">2</span>

<span class="va">rf_mod</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/rand_forest.html">rand_forest</a></span><span class="op">(</span>mtry <span class="op">=</span> <span class="fu"><a href="https://tune.tidymodels.org/reference/tune.html">tune</a></span><span class="op">(</span><span class="op">)</span>, min_n <span class="op">=</span> <span class="fu"><a href="https://tune.tidymodels.org/reference/tune.html">tune</a></span><span class="op">(</span><span class="op">)</span>, trees <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_engine.html">set_engine</a></span><span class="op">(</span><span class="st">"randomForest"</span>, num.threads <span class="op">=</span> <span class="va">cores</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_args.html">set_mode</a></span><span class="op">(</span><span class="st">"classification"</span><span class="op">)</span>

<span class="va">rf_recipe</span> <span class="op">&lt;-</span>
  <span class="op">~</span> <span class="va">.x</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html">recipe</a></span><span class="op">(</span><span class="va">children</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_date.html">step_date</a></span><span class="op">(</span><span class="va">arrival_date</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_holiday.html">step_holiday</a></span><span class="op">(</span><span class="va">arrival_date</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_rm.html">step_rm</a></span><span class="op">(</span><span class="va">arrival_date</span><span class="op">)</span>

<span class="va">tflow</span> <span class="op">&lt;-</span>
  <span class="va">tflow</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plug_recipe.html">replace_recipe</a></span><span class="op">(</span><span class="va">rf_recipe</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plug_model.html">replace_model</a></span><span class="op">(</span><span class="va">rf_mod</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plug_grid.html">replace_grid</a></span><span class="op">(</span><span class="va">grid_latin_hypercube</span>, size <span class="op">=</span> <span class="fl">25</span><span class="op">)</span>

<span class="va">rf_res</span> <span class="op">&lt;-</span> <span class="va">tflow</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>control <span class="op">=</span> <span class="va">cntrl</span><span class="op">)</span>

<span class="va">rf_res</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/tidyflow-extractors.html">pull_tflow_fit_tuning</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.window.html">ylim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.88</span>, <span class="fl">0.93</span><span class="op">)</span><span class="op">)</span>

<span class="va">rf_best</span> <span class="op">&lt;-</span>
  <span class="va">rf_res</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/tidyflow-extractors.html">pull_tflow_fit_tuning</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tune.tidymodels.org/reference/show_best.html">select_best</a></span><span class="op">(</span>metric <span class="op">=</span> <span class="st">"roc_auc"</span><span class="op">)</span>

<span class="va">rf_auc</span> <span class="op">&lt;-</span>
  <span class="va">rf_res</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/tidyflow-extractors.html">pull_tflow_fit_tuning</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tune.tidymodels.org/reference/collect_predictions.html">collect_predictions</a></span><span class="op">(</span>parameters <span class="op">=</span> <span class="va">rf_best</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">roc_curve</span><span class="op">(</span><span class="va">children</span>, <span class="va">.pred_children</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>model <span class="op">=</span> <span class="st">"Random Forest"</span><span class="op">)</span>

<span class="fu">bind_rows</span><span class="op">(</span><span class="va">rf_auc</span>, <span class="va">lr_auc</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">specificity</span>, y <span class="op">=</span> <span class="va">sensitivity</span>, col <span class="op">=</span> <span class="va">model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_path</span><span class="op">(</span>lwd <span class="op">=</span> <span class="fl">1.5</span>, alpha <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_abline</span><span class="op">(</span>lty <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_color_viridis_d</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"plasma"</span>, end <span class="op">=</span> <span class="fl">.6</span><span class="op">)</span>

<span class="va">final_res</span> <span class="op">&lt;-</span>
  <span class="va">rf_res</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/complete_tflow.html">complete_tflow</a></span><span class="op">(</span>metric <span class="op">=</span> <span class="st">"roc_auc"</span><span class="op">)</span>

<span class="va">final_res</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/predict-tidyflow.html">predict_testing</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">roc_curve</span><span class="op">(</span><span class="va">children</span>, <span class="va">.pred_children</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://cimentadaj.github.io">Jorge Cimentada</a>, Davis Vaughan.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
